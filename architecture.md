# Архитектура корпоративного AI-чатбота

## Обзор системы

Корпоративный AI-чатбот представляет собой многокомпонентную систему, объединяющую современные технологии машинного обучения, векторный поиск и автоматизацию workflow для предоставления специализированной помощи сотрудникам компании.

## Архитектурная схема

```
┌─────────────────────────────────────────────────────────────────┐
│                         ПОЛЬЗОВАТЕЛИ                             │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│                      TELEGRAM BOT API                            │
│                  (Интерфейс пользователя)                        │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│                         n8n WORKFLOW                             │
│              (Оркестрация и обработка запросов)                  │
│  ┌─────────────┐  ┌──────────────┐  ┌─────────────────────┐   │
│  │   Webhook   │─▶│  Parse Data  │─▶│  Call Python API    │   │
│  └─────────────┘  └──────────────┘  └─────────────────────┘   │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│                      PYTHON BACKEND                              │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                    TELEGRAM BOT                           │  │
│  │  • Обработка команд                                       │  │
│  │  • Управление сессиями                                    │  │
│  │  • Роутинг к агентам                                      │  │
│  └────────────────────────┬─────────────────────────────────┘  │
│                            │                                     │
│  ┌─────────────────────────┴──────────────────────────────────┐│
│  │                    АГЕНТЫ (AGENTS)                          ││
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐    ││
│  │  │  Финансовый  │  │ Юридический  │  │  Проектный   │    ││
│  │  │    агент     │  │    агент     │  │    агент     │    ││
│  │  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘    ││
│  │         │                  │                  │             ││
│  │         └──────────────────┴──────────────────┘             ││
│  │                            │                                 ││
│  └────────────────────────────┼─────────────────────────────────┘│
│                               │                                  │
│  ┌────────────────────────────┼─────────────────────────────┐  │
│  │                            ▼                              │  │
│  │              CORE COMPONENTS                              │  │
│  │  ┌────────────────────────────────────────────────────┐  │  │
│  │  │             LLM CLIENT                              │  │  │
│  │  │  • Генерация эмбеддингов                          │  │  │
│  │  │  • Генерация ответов                              │  │  │
│  │  │  • Fallback механизм                              │  │  │
│  │  └───────────────────┬────────────────────────────────┘  │  │
│  │                      │                                    │  │
│  │  ┌───────────────────▼────────────────────────────────┐  │  │
│  │  │            VECTOR STORE                            │  │  │
│  │  │  • Векторный поиск                                │  │  │
│  │  │  • Управление документами                         │  │  │
│  │  │  • Извлечение контекста                           │  │  │
│  │  └────────────────────────────────────────────────────┘  │  │
│  └──────────────────────────────────────────────────────────┘  │
└────────────────────────────┬────────────────────────────────────┘
                             │
          ┌──────────────────┼──────────────────┐
          │                  │                  │
          ▼                  ▼                  ▼
┌──────────────────┐ ┌──────────────┐ ┌─────────────────┐
│   OpenAI API     │ │   Pinecone   │ │  Telegram API   │
│  • GPT-4 mini    │ │  Vector DB   │ │   • Bot API     │
│  • Embeddings    │ │              │ │   • Webhooks    │
└──────────────────┘ └──────────────┘ └─────────────────┘
```

## Компоненты системы

### 1. Пользовательский интерфейс (Telegram Bot)

**Назначение**: Основной интерфейс взаимодействия пользователей с системой

**Функции**:
- Прием текстовых запросов от пользователей
- Управление сессиями и выбором агентов
- Отправка ответов пользователям
- Обработка команд (/start, /help, и т.д.)

**Технологии**: 
- Python Telegram Bot API
- python-telegram-bot library

### 2. Оркестратор (n8n)

**Назначение**: Управление workflow и интеграция компонентов

**Функции**:
- Прием webhook от Telegram
- Маршрутизация запросов
- Обработка ошибок
- Логирование событий

**Технологии**: 
- n8n (SaaS или self-hosted)
- Workflow automation

**Преимущества использования n8n**:
- Визуальная настройка workflow без кода
- Легкая интеграция различных сервисов
- Мониторинг и отладка процессов
- Масштабируемость

### 3. Backend (Python Application)

#### 3.1. Telegram Bot Controller

**Файл**: `src/core/telegram_bot.py`

**Ответственность**:
- Обработка входящих сообщений
- Управление контекстом пользователя
- Роутинг к соответствующему агенту
- Аутентификация и авторизация

**Ключевые методы**:
- `handle_message()` - обработка текстовых сообщений
- `start_command()` - инициализация диалога
- `_switch_agent()` - переключение между агентами

#### 3.2. Агенты (Agents)

**Базовый класс**: `src/agents/base_agent.py`

**Специализированные агенты**:

1. **Финансовый агент** (`finance_agent.py`)
   - Namespace в Pinecone: `finance`
   - Специализация: бюджеты, оплаты, финансовые политики
   - Системный промпт: настроен на точность с цифрами и датами

2. **Юридический агент** (`legal_agent.py`)
   - Namespace в Pinecone: `legal`
   - Специализация: НПА, контракты, процедуры
   - Системный промпт: акцент на ссылки на документы

3. **Проектный агент** (`project_agent.py`)
   - Namespace в Pinecone: `project`
   - Специализация: задачи, дедлайны, риски
   - Системный промпт: приоритизация по важности

**Общий workflow агента**:
```
1. Получение запроса пользователя
2. Генерация эмбеддинга запроса
3. Поиск в векторной БД (Pinecone)
4. Извлечение контекста из результатов
5. Генерация ответа через LLM
6. Возврат структурированного ответа
```

#### 3.3. LLM Client

**Файл**: `src/core/llm_client.py`

**Функции**:
- `generate_embedding()` - векторизация текста
- `generate_response()` - генерация ответа на основе контекста
- `generate_fallback_response()` - ответ при отсутствии данных в БЗ

**Настройки**:
- Model: GPT-4 mini
- Temperature: 0.3 (для точности)
- Max tokens: 1000

#### 3.4. Vector Store

**Файл**: `src/core/vector_store.py`

**Функции**:
- `search()` - векторный поиск по запросу
- `upsert_documents()` - загрузка документов
- `get_stats()` - статистика по индексу

**Pinecone конфигурация**:
- Dimension: 1536 (OpenAI embeddings)
- Metric: cosine similarity
- Namespaces: finance, legal, project

### 4. Внешние сервисы

#### 4.1. OpenAI API

**Использование**:
- **GPT-4 mini**: генерация ответов
- **text-embedding-3-small**: векторизация

**Параметры**:
- Temperature: 0.3
- Max tokens: 1000

#### 4.2. Pinecone Vector Database

**Структура**:
```
Index: corporate-kb
├── Namespace: finance
│   └── Vectors: финансовые документы
├── Namespace: legal
│   └── Vectors: юридические документы
└── Namespace: project
    └── Vectors: проектные документы
```

**Метаданные**:
- `text`: оригинальный текст фрагмента
- `source`: имя файла-источника
- `chunk_index`: индекс фрагмента
- `char_count`: размер текста

## Поток данных

### Обработка пользовательского запроса

```
1. Пользователь отправляет сообщение в Telegram
   │
   ▼
2. Telegram Bot API отправляет webhook в n8n
   │
   ▼
3. n8n парсит данные и вызывает Python Backend
   │
   ▼
4. Backend определяет активного агента пользователя
   │
   ▼
5. Агент генерирует эмбеддинг запроса (OpenAI)
   │
   ▼
6. Агент ищет релевантные документы (Pinecone)
   │
   ├─▶ Найдены документы (score > 0.7)
   │   │
   │   ▼
   │   7a. Извлечение контекста из документов
   │   │
   │   ▼
   │   8a. Генерация ответа на основе контекста (GPT-4 mini)
   │
   └─▶ Документы не найдены
       │
       ▼
       7b. Генерация fallback ответа (GPT-4 mini)
       │
       ▼
       8b. Ответ с предупреждением о fallback
   │
   ▼
9. Ответ отправляется через n8n обратно в Telegram
   │
   ▼
10. Пользователь получает ответ
```

### Загрузка документов

```
1. Документы размещаются в data/{agent}/
   │
   ▼
2. Запуск скрипта load_documents.py
   │
   ▼
3. Чтение и разбиение на chunks (1000 символов)
   │
   ▼
4. Генерация эмбеддингов для каждого chunk (OpenAI)
   │
   ▼
5. Загрузка векторов в Pinecone с метаданными
   │
   ▼
6. Документы доступны для поиска
```

## Обработка ошибок

### Типы ошибок

1. **API ошибки** (OpenAI, Pinecone, Telegram)
   - Retry механизм (3 попытки)
   - Exponential backoff
   - Fallback на alternative endpoints

2. **Отсутствие данных**
   - Явное сообщение пользователю
   - Fallback на знания модели с предупреждением
   - Логирование для улучшения БЗ

3. **Превышение времени ответа**
   - Timeout: 3 секунды
   - Асинхронная обработка
   - Предупреждение пользователя

4. **Неавторизованный доступ**
   - Проверка user_id
   - Отказ в доступе с сообщением
   - Логирование попыток

### Механизмы отказоустойчивости

- **Retry logic**: автоматические повторные попытки
- **Circuit breaker**: временное отключение неработающих сервисов
- **Graceful degradation**: работа в ограниченном режиме
- **Health checks**: мониторинг состояния компонентов

## Безопасность

### Меры безопасности

1. **Аутентификация**
   - Whitelist user_id в Telegram
   - API keys для внешних сервисов
   - Environment variables для credentials

2. **Конфиденциальность**
   - Логирование без PII
   - Шифрование данных при передаче
   - Изоляция namespaces в Pinecone

3. **Валидация**
   - Санитизация входящих данных
   - Rate limiting (10 req/min, 100 req/hour)
   - Input validation

4. **Мониторинг**
   - Логирование всех запросов
   - Tracking suspicious activity
   - Alert на аномалии

## Масштабируемость

### Горизонтальное масштабирование

- **Stateless backend**: можно запустить множество инстансов
- **Load balancing**: распределение нагрузки через n8n
- **Vector DB sharding**: разделение данных в Pinecone

### Вертикальное масштабирование

- **Увеличение ресурсов**: CPU, RAM для инстансов
- **Batching**: обработка нескольких запросов вместе
- **Caching**: Redis для часто запрашиваемых данных

### Добавление новых агентов

1. Создать новый класс агента (наследование от BaseAgent)
2. Определить namespace в Pinecone
3. Загрузить документы в новый namespace
4. Зарегистрировать агента в TelegramBot
5. Добавить команду для активации

## Мониторинг и метрики

### Ключевые метрики

- **Response time**: среднее время ответа (цель: ≤3s)
- **Accuracy**: процент корректных ответов (цель: ≥85%)
- **Availability**: uptime системы (цель: 99%)
- **Error rate**: процент ошибок (цель: <5%)

### Логирование

- **Structured logging**: JSON формат для продакшн
- **Log levels**: DEBUG, INFO, WARNING, ERROR, CRITICAL
- **Log rotation**: автоматическая ротация файлов
- **Centralized logging**: агрегация логов

### Алерты

- **Performance degradation**: время ответа > 3s
- **High error rate**: ошибки > 5%
- **API failures**: недоступность внешних сервисов
- **Low accuracy**: точность < 85%

## Развертывание

### Docker deployment

```bash
docker-compose up -d
```

### Cloud deployment options

1. **AWS**
   - ECS/Fargate для контейнеров
   - CloudWatch для логов
   - Lambda для webhook обработки

2. **Google Cloud**
   - Cloud Run для контейнеров
   - Cloud Logging
   - Cloud Functions

3. **Azure**
   - Container Instances
   - Application Insights
   - Azure Functions

### CI/CD

1. GitHub Actions для автоматизации
2. Automated testing перед деплоем
3. Blue-green deployment стратегия
4. Rollback механизм

## Будущие улучшения

### Краткосрочные (3-6 месяцев)

- Добавление новых агентов (HR, IT Support)
- Мультиязычность (EN, KZ)
- Voice messages support
- Rich media responses (изображения, таблицы)

### Долгосрочные (6-12 месяцев)

- Personalization на основе истории
- Predictive suggestions
- Integration с другими корпоративными системами
- Advanced analytics и reporting
- Fine-tuned модель на корпоративных данных
